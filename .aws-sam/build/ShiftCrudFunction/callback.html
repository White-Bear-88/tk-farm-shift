<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン処理中...</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #dc3545;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <h3>ログイン処理中...</h3>
        <p id="status">認証情報を確認しています</p>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script src="cognite-auth-config.js"></script>
    <script>
        const API_BASE_URL = 'https://mxh6g7opm2.execute-api.ap-northeast-1.amazonaws.com/dev';

        async function handleCallback() {
            try {
                // URLフラグメントからIDトークンを取得
                const fragment = window.location.hash.substring(1);
                const params = new URLSearchParams(fragment);
                
                const idToken = params.get('id_token');
                const state = params.get('state');
                const error = params.get('error');

                // エラーチェック
                if (error) {
                    throw new Error(`認証エラー: ${error}`);
                }

                // state パラメータ検証（CSRF対策）
                const savedState = sessionStorage.getItem('cognite_auth_state');
                if (!state || state !== savedState) {
                    throw new Error('不正な認証リクエストです');
                }

                if (!idToken) {
                    throw new Error('IDトークンが取得できませんでした');
                }

                document.getElementById('status').textContent = 'ユーザー情報を確認中...';

                // JWTからsubを取得
                const payload = parseJWT(idToken);
                const sub = payload.sub;
                const nonce = payload.nonce;

                // nonce検証（リプレイ攻撃対策）
                const savedNonce = sessionStorage.getItem('cognite_auth_nonce');
                if (nonce !== savedNonce) {
                    throw new Error('不正な認証リクエストです');
                }

                if (!sub) {
                    throw new Error('ユーザーIDが取得できませんでした');
                }

                // subを使って従業員情報を取得
                const userInfo = await getUserBySub(sub);

                if (!userInfo) {
                    throw new Error('ユーザーが見つかりません。管理者にお問い合わせください。');
                }

                if (!userInfo.is_active) {
                    throw new Error('このアカウントは無効化されています');
                }

                // トークンを保存
                localStorage.setItem('cognite_id_token', idToken);
                localStorage.setItem('user_info', JSON.stringify(userInfo));
                
                // セッションストレージをクリア
                sessionStorage.removeItem('cognite_auth_state');
                sessionStorage.removeItem('cognite_auth_nonce');

                document.getElementById('status').textContent = 'ログイン完了！リダイレクト中...';

                // ロールに応じて画面を振り分け
                setTimeout(() => {
                    if (userInfo.role === 'admin') {
                        window.location.href = 'menu.html';
                    } else {
                        window.location.href = 'employee-view.html';
                    }
                }, 1000);

            } catch (error) {
                console.error('コールバック処理エラー:', error);
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('status').textContent = 'ログインに失敗しました';
                
                // 3秒後にログイン画面に戻る
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        }

        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                throw new Error('JWTトークンの解析に失敗しました');
            }
        }

        async function getUserBySub(sub) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/user-by-sub/${sub}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return null;
                    }
                    throw new Error('ユーザー情報の取得に失敗しました');
                }

                return await response.json();
            } catch (error) {
                console.error('ユーザー取得エラー:', error);
                throw error;
            }
        }

        // ページ読み込み時にコールバック処理を実行
        document.addEventListener('DOMContentLoaded', handleCallback);
    </script>
</body>
</html>