<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>日別シフト詳細</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display:flex; justify-content:space-between; align-items:center }
        table { width: 100%; border-collapse: collapse; margin-top: 16px }
        th, td { padding: 8px 12px; border: 1px solid #ddd }
        th { background: #f1f1f1; text-align: left }
        .muted { color:#666 }
        .btn { padding:6px 10px; border-radius:4px; background:#007bff; color:white; border:none; cursor:pointer }
        .btn[disabled] { background:#ccc; cursor:not-allowed }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2 id="pageTitle">日別シフト</h2>
        <a id="backToMonth" href="shifts.html">← 月間へ戻る</a>
    </div>

    <div id="meta" class="muted">読み込み中...</div>

    <table id="shiftTable">
        <thead>
            <tr><th>作業</th><th>時間</th><th>担当者</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const API_BASE = 'https://mxh6g7opm2.execute-api.ap-northeast-1.amazonaws.com/dev';

function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}

async function fetchEmployees() {
    const res = await fetch(`${API_BASE}/employees`);
    return await res.json();
}

function isPast(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const today = new Date();
    today.setHours(0,0,0,0);
    return d < today;
}

function getTaskName(taskType) {
    const names = {'milking':'搾乳','feeding':'給餌','cleaning':'清掃','patrol':'見回り'};
    return names[taskType] || taskType;
}

async function loadDay(date) {
    document.getElementById('pageTitle').textContent = `${date} のシフト`;
    const meta = document.getElementById('meta');
    const tbody = document.querySelector('#shiftTable tbody');
    tbody.innerHTML = '';

        function showMetaMessage(message, type='info') {
            meta.textContent = message;
            if (type === 'success') meta.style.color = 'green';
            else if (type === 'error') meta.style.color = 'red';
            else meta.style.color = '#666';
        }
            fetch(`${API_BASE}/shifts/by-date/${date}`),
            fetch(`${API_BASE}/employees`)
        ]);
        const shifts = (await shiftRes.json()) || [];
        const empList = await employees.json();

        // employee id => name
        const empMap = {};
        empList.forEach(e => empMap[e.employee_id] = e.name);

        // for candidate lists, precompute skill mapping
        const skillMap = {};
        empList.forEach(e => {
            (e.skills || []).forEach(skill => {
                skillMap[skill] = skillMap[skill] || [];
                skillMap[skill].push({id: e.employee_id, name: e.name});
            });
        });

        if (shifts.length === 0) {
            meta.textContent = '該当するシフトはありません';
            return;
        }

        const past = isPast(date);
        meta.textContent = past ? '過去日のため編集できません' : '今日以降のシフトは編集できます';

        // Render rows
        for (const s of shifts) {
            const tr = document.createElement('tr');
            const taskName = getTaskName(s.task_type);
            tr.innerHTML = `
                <td>${taskName}</td>
                <td>${s.start_time} - ${s.end_time}</td>
                <td class="assignee-cell">${empMap[s.employee_id] || s.employee_id}</td>
                <td class="action-cell"></td>
            `;

            const actionTd = tr.querySelector('.action-cell');
            if (!past) {
                // Add select of candidates
                const candidates = skillMap[s.task_type] || [];
                const select = document.createElement('select');
                candidates.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    if (c.id === s.employee_id) opt.selected = true;
                    select.appendChild(opt);
                });
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn';
                saveBtn.textContent = '変更保存';
                saveBtn.onclick = async () => {
                    const newEmp = select.value;
                    if (newEmp === s.employee_id) {
                        showMetaMessage('担当は変わっていません','info');
                        return;
                    }
                    // Call API to reassign
                    try {
                        const res = await fetch(`${API_BASE}/shifts/${s.shift_id}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({employee_id: newEmp})
                        });
                        if (!res.ok) {
                            let txt = await res.text();
                            try { const j = JSON.parse(txt); txt = j.error || j.message || txt; } catch(e){}
                            throw new Error(txt || '変更に失敗しました');
                        }
                        // Update UI
                        tr.querySelector('.assignee-cell').textContent = empMap[newEmp] || newEmp;
                        s.employee_id = newEmp;
                        showMetaMessage('担当を変更しました','success');
                    } catch (err) {
                        console.error(err);
                        showMetaMessage(`変更に失敗しました: ${err.message}`,'error');
                    }
                };

                if (candidates.length === 0) {
                    actionTd.textContent = '候補者がいません（スキル保有者が不在）';
                } else {
                    actionTd.appendChild(select);
                    actionTd.appendChild(document.createTextNode(' '));
                    actionTd.appendChild(saveBtn);
                }
            } else {
                actionTd.textContent = '編集不可';
            }

            tbody.appendChild(tr);
        }

    } catch (err) {
        console.error(err);
        meta.textContent = 'データ取得エラー';
    }
}

// Initialize
const date = getQueryParam('date') || new Date().toISOString().split('T')[0];
// Set back link to preserve month
const back = document.getElementById('backToMonth');
if (back) {
    back.href = `shifts.html?month=${date.substr(0,7)}`;
}
loadDay(date);
</script>
</body>
</html>